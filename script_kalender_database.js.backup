/**
 * Kalender Shift Karyawan - Database Integration
 * Menggunakan database aplikasi di phpMyAdmin sebagai sumber data tunggal
 */

let currentCabangId = null;
let pegawaiList = [];
let shiftAssignments = [];
let currentMonth = new Date();
let currentView = 'month'; // default view

// Initialize kalender saat halaman dimuat
document.addEventListener('DOMContentLoaded', function() {
    initializeKalenderDatabase();
});

function initializeKalenderDatabase() {
    console.log('Initializing Kalender Database Integration...');
    
    // Load cabang list
    loadCabangList();
    
    // Setup event listeners
    setupEventListeners();
    
    // Load initial data (semua assignments tanpa filter cabang)
    loadMonthData(currentMonth);
}

function setupEventListeners() {
    // View buttons
    const viewDayBtn = document.getElementById('view-day');
    const viewWeekBtn = document.getElementById('view-week');
    const viewMonthBtn = document.getElementById('view-month');
    const viewYearBtn = document.getElementById('view-year');
    
    if (viewDayBtn) {
        viewDayBtn.addEventListener('click', function() {
            switchView('day');
        });
    }
    
    if (viewWeekBtn) {
        viewWeekBtn.addEventListener('click', function() {
            switchView('week');
        });
    }
    
    if (viewMonthBtn) {
        viewMonthBtn.addEventListener('click', function() {
            switchView('month');
        });
    }
    
    if (viewYearBtn) {
        viewYearBtn.addEventListener('click', function() {
            switchView('year');
        });
    }
    
    // Cabang selector
    const cabangSelect = document.getElementById('cabang-select');
    if (cabangSelect) {
        cabangSelect.addEventListener('change', function() {
            currentCabangId = this.value || null;
            loadPegawaiList();
            loadMonthData(currentMonth);
        });
    }
    
    // Navigation buttons
    const prevBtn = document.getElementById('prev-nav');
    const nextBtn = document.getElementById('next-nav');
    
    if (prevBtn) {
        prevBtn.addEventListener('click', function() {
            currentMonth.setMonth(currentMonth.getMonth() - 1);
            loadMonthData(currentMonth);
        });
    }
    
    if (nextBtn) {
        nextBtn.addEventListener('click', function() {
            currentMonth.setMonth(currentMonth.getMonth() + 1);
            loadMonthData(currentMonth);
        });
    }
}

// Load daftar cabang dari database
async function loadCabangList() {
    try {
        const response = await fetch('api_shift_calendar.php?action=get_cabang');
        const result = await response.json();
        
        if (result.status === 'success') {
            const cabangSelect = document.getElementById('cabang-select');
            if (cabangSelect) {
                // Clear existing options except first
                while (cabangSelect.options.length > 1) {
                    cabangSelect.remove(1);
                }
                
                // Group by nama_cabang
                const cabangGroups = {};
                result.data.forEach(cabang => {
                    if (!cabangGroups[cabang.nama_cabang]) {
                        cabangGroups[cabang.nama_cabang] = [];
                    }
                    cabangGroups[cabang.nama_cabang].push(cabang);
                });
                
                // Add options grouped by cabang
                Object.keys(cabangGroups).forEach(namaCabang => {
                    cabangGroups[namaCabang].forEach(cabang => {
                        const option = document.createElement('option');
                        option.value = cabang.id;
                        option.textContent = `${cabang.nama_cabang} - ${cabang.nama_shift} (${cabang.jam_masuk}-${cabang.jam_keluar})`;
                        cabangSelect.appendChild(option);
                    });
                });
                
                // Load all pegawai initially
                loadPegawaiList();
            }
        }
    } catch (error) {
        console.error('Error loading cabang list:', error);
    }
}

// Load daftar pegawai
async function loadPegawaiList() {
    try {
        let url = 'api_shift_calendar.php?action=get_pegawai';
        if (currentCabangId) {
            url += `&cabang_id=${currentCabangId}`;
        }
        
        const response = await fetch(url);
        const result = await response.json();
        
        if (result.status === 'success') {
            pegawaiList = result.data;
            
            // Update employee selector
            const employeeSelect = document.getElementById('employee-select');
            if (employeeSelect) {
                // Clear existing options except first
                while (employeeSelect.options.length > 1) {
                    employeeSelect.remove(1);
                }
                
                // Add pegawai options
                pegawaiList.forEach(pegawai => {
                    const option = document.createElement('option');
                    option.value = pegawai.id;
                    option.textContent = `${pegawai.name} - ${pegawai.posisi || 'N/A'}`;
                    employeeSelect.appendChild(option);
                });
            }
        }
    } catch (error) {
        console.error('Error loading pegawai list:', error);
    }
}

// Load data shift untuk bulan tertentu
async function loadMonthData(date) {
    try {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const monthStr = `${year}-${month}`;
        
        let url = `api_shift_calendar.php?action=get_assignments&month=${monthStr}`;
        if (currentCabangId) {
            url += `&cabang_id=${currentCabangId}`;
        }
        
        const response = await fetch(url);
        const result = await response.json();
        
        if (result.status === 'success') {
            shiftAssignments = result.data;
            
            // Update navigation label
            updateNavigationLabel(date);
            
            // Render calendar with data
            renderCalendarWithData(date);
        }
    } catch (error) {
        console.error('Error loading month data:', error);
    }
}

// Update navigation label
function updateNavigationLabel(date) {
    const currentNav = document.getElementById('current-nav');
    if (currentNav) {
        const options = { year: 'numeric', month: 'long' };
        currentNav.textContent = date.toLocaleDateString('id-ID', options);
    }
}

// Render kalender dengan data dari database
function renderCalendarWithData(date) {
    const calendarBody = document.getElementById('calendar-body');
    if (!calendarBody) return;
    
    calendarBody.innerHTML = '';
    
    const year = date.getFullYear();
    const month = date.getMonth();
    
    // Get first day of month and total days
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const totalDays = lastDay.getDate();
    
    // Start from Monday (1 = Monday in getDay with offset)
    let dayOfWeek = firstDay.getDay();
    dayOfWeek = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Convert Sunday (0) to 6
    
    let currentDay = 1;
    let row = document.createElement('tr');
    
    // Fill empty cells before first day
    for (let i = 0; i < dayOfWeek; i++) {
        const cell = document.createElement('td');
        cell.className = 'empty-cell';
        row.appendChild(cell);
    }
    
    // Fill days of month
    while (currentDay <= totalDays) {
        const cell = document.createElement('td');
        cell.className = 'calendar-day';
        
        const dayNumber = document.createElement('div');
        dayNumber.className = 'day-number';
        dayNumber.textContent = currentDay;
        cell.appendChild(dayNumber);
        
        // Check if there are assignments for this day
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(currentDay).padStart(2, '0')}`;
        const dayAssignments = shiftAssignments.filter(a => a.tanggal_shift === dateStr);
        
        if (dayAssignments.length > 0) {
            const assignmentContainer = document.createElement('div');
            assignmentContainer.className = 'shift-assignments';
            
            dayAssignments.forEach(assignment => {
                const assignmentDiv = document.createElement('div');
                assignmentDiv.className = 'shift-assignment';
                assignmentDiv.textContent = `${assignment.nama_lengkap} - ${assignment.nama_shift}`;
                assignmentDiv.title = `${assignment.nama_cabang}\n${assignment.jam_masuk} - ${assignment.jam_keluar}`;
                assignmentDiv.dataset.assignmentId = assignment.id;
                
                // Add click handler untuk edit/delete
                assignmentDiv.addEventListener('click', function(e) {
                    e.stopPropagation();
                    showAssignmentMenu(assignment, assignmentDiv);
                });
                
                assignmentContainer.appendChild(assignmentDiv);
            });
            
            cell.appendChild(assignmentContainer);
        }
        
        // Add click handler untuk add assignment
        cell.addEventListener('click', function() {
            if (!currentCabangId) {
                alert('Silakan pilih cabang terlebih dahulu');
                return;
            }
            showAddAssignmentDialog(dateStr);
        });
        
        row.appendChild(cell);
        
        // Start new row after Saturday
        if ((dayOfWeek + currentDay) % 7 === 0) {
            calendarBody.appendChild(row);
            row = document.createElement('tr');
        }
        
        currentDay++;
    }
    
    // Fill remaining cells
    if (row.children.length > 0) {
        while (row.children.length < 7) {
            const cell = document.createElement('td');
            cell.className = 'empty-cell';
            row.appendChild(cell);
        }
        calendarBody.appendChild(row);
    }
}

// Show dialog untuk menambah assignment
function showAddAssignmentDialog(dateStr) {
    const employeeSelect = document.getElementById('employee-select');
    
    if (!employeeSelect || !employeeSelect.value) {
        alert('Silakan pilih karyawan terlebih dahulu');
        return;
    }
    
    const userId = employeeSelect.value;
    const employeeName = employeeSelect.options[employeeSelect.selectedIndex].text;
    
    if (confirm(`Assign shift ke ${employeeName} pada tanggal ${dateStr}?`)) {
        createAssignment(userId, dateStr);
    }
}

// Create shift assignment
async function createAssignment(userId, dateStr) {
    try {
        const response = await fetch('api_shift_calendar.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                action: 'create',
                user_id: userId,
                cabang_id: currentCabangId,
                tanggal_shift: dateStr
            })
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            alert('Shift berhasil di-assign!');
            loadMonthData(currentMonth);
        } else {
            alert('Error: ' + result.message);
        }
    } catch (error) {
        console.error('Error creating assignment:', error);
        alert('Terjadi kesalahan saat membuat assignment');
    }
}

// Show menu untuk assignment (edit/delete)
function showAssignmentMenu(assignment, element) {
    const menu = confirm(`${assignment.nama_lengkap}\n${assignment.nama_cabang} - ${assignment.nama_shift}\n${assignment.jam_masuk} - ${assignment.jam_keluar}\n\nHapus assignment ini?`);
    
    if (menu) {
        deleteAssignment(assignment.id);
    }
}

// Delete shift assignment
async function deleteAssignment(assignmentId) {
    try {
        const response = await fetch('api_shift_calendar.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                action: 'delete',
                id: assignmentId
            })
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            alert('Shift berhasil dihapus!');
            loadMonthData(currentMonth);
        } else {
            alert('Error: ' + result.message);
        }
    } catch (error) {
        console.error('Error deleting assignment:', error);
        alert('Terjadi kesalahan saat menghapus assignment');
    }
}

// Switch between different calendar views
function switchView(view) {
    currentView = view;
    
    // Hide all views
    document.getElementById('month-view').style.display = 'none';
    document.getElementById('week-view').style.display = 'none';
    document.getElementById('day-view').style.display = 'none';
    document.getElementById('year-view').style.display = 'none';
    
    // Remove active class from all view buttons
    document.querySelectorAll('.view-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected view and activate button
    switch(view) {
        case 'day':
            document.getElementById('day-view').style.display = 'block';
            document.getElementById('view-day').classList.add('active');
            updateNavigationLabels('Hari Sebelumnya', 'Hari Berikutnya');
            renderDayView();
            break;
        case 'week':
            document.getElementById('week-view').style.display = 'block';
            document.getElementById('view-week').classList.add('active');
            updateNavigationLabels('Minggu Sebelumnya', 'Minggu Berikutnya');
            renderWeekView();
            break;
        case 'month':
            document.getElementById('month-view').style.display = 'block';
            document.getElementById('view-month').classList.add('active');
            updateNavigationLabels('Bulan Sebelumnya', 'Bulan Berikutnya');
            loadMonthData(currentMonth);
            break;
        case 'year':
            document.getElementById('year-view').style.display = 'block';
            document.getElementById('view-year').classList.add('active');
            updateNavigationLabels('Tahun Sebelumnya', 'Tahun Berikutnya');
            renderYearView();
            break;
    }
}

function updateNavigationLabels(prevLabel, nextLabel) {
    const prevLabelEl = document.getElementById('prev-label');
    const nextLabelEl = document.getElementById('next-label');
    if (prevLabelEl) prevLabelEl.textContent = prevLabel;
    if (nextLabelEl) nextLabelEl.textContent = nextLabel;
}

function renderDayView() {
    const dayView = document.getElementById('day-calendar');
    if (!dayView) return;
    
    // Update day date display
    const dayDate = document.getElementById('day-date');
    if (dayDate) {
        dayDate.textContent = currentMonth.toLocaleDateString('id-ID', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
    }
    
    // Render time slots for the day
    const timeColumn = document.getElementById('day-time-column');
    const dayContent = document.getElementById('day-content');
    
    if (timeColumn && dayContent) {
        timeColumn.innerHTML = '';
        dayContent.innerHTML = '';
        
        // Generate 24 hour time slots
        for (let hour = 0; hour < 24; hour++) {
            const timeSlot = document.createElement('div');
            timeSlot.className = 'time-slot';
            timeSlot.textContent = `${hour.toString().padStart(2, '0')}:00`;
            timeColumn.appendChild(timeSlot);
            
            const contentSlot = document.createElement('div');
            contentSlot.className = 'day-slot';
            contentSlot.dataset.hour = hour;
            dayContent.appendChild(contentSlot);
        }
        
        // Load assignments for this day
        loadDayAssignments(currentMonth);
    }
}

function renderWeekView() {
    const weekView = document.getElementById('week-calendar');
    if (!weekView) return;
    
    // Get start of week (Sunday)
    const startOfWeek = new Date(currentMonth);
    startOfWeek.setDate(currentMonth.getDate() - currentMonth.getDay());
    
    // Update week range display
    const weekRange = document.getElementById('week-range');
    const endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 6);
    
    if (weekRange) {
        weekRange.textContent = `${startOfWeek.toLocaleDateString('id-ID')} - ${endOfWeek.toLocaleDateString('id-ID')}`;
    }
    
    // Render time column
    const timeColumn = document.getElementById('time-column');
    const daysColumn = document.getElementById('days-column');
    
    if (timeColumn && daysColumn) {
        timeColumn.innerHTML = '';
        daysColumn.innerHTML = '';
        
        // Generate time slots
        for (let hour = 0; hour < 24; hour++) {
            const timeSlot = document.createElement('div');
            timeSlot.className = 'time-slot';
            timeSlot.textContent = `${hour.toString().padStart(2, '0')}:00`;
            timeColumn.appendChild(timeSlot);
        }
        
        // Generate day columns
        const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
        for (let i = 0; i < 7; i++) {
            const dayCol = document.createElement('div');
            dayCol.className = 'day-column';
            
            const dayHeader = document.createElement('div');
            dayHeader.className = 'day-header';
            const currentDay = new Date(startOfWeek);
            currentDay.setDate(startOfWeek.getDate() + i);
            dayHeader.textContent = `${days[i]}, ${currentDay.getDate()}`;
            dayCol.appendChild(dayHeader);
            
            // Add time slots for each day
            for (let hour = 0; hour < 24; hour++) {
                const slot = document.createElement('div');
                slot.className = 'week-slot';
                slot.dataset.date = currentDay.toISOString().split('T')[0];
                slot.dataset.hour = hour;
                dayCol.appendChild(slot);
            }
            
            daysColumn.appendChild(dayCol);
        }
        
        // Load assignments for this week
        loadWeekAssignments(startOfWeek);
    }
}

function renderYearView() {
    const yearGrid = document.getElementById('year-grid');
    if (!yearGrid) return;
    
    yearGrid.innerHTML = '';
    
    const year = currentMonth.getFullYear();
    const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                   'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
    
    months.forEach((monthName, index) => {
        const monthCard = document.createElement('div');
        monthCard.className = 'month-card';
        
        const monthHeader = document.createElement('h3');
        monthHeader.textContent = monthName;
        monthCard.appendChild(monthHeader);
        
        const miniCalendar = document.createElement('div');
        miniCalendar.className = 'mini-calendar';
        
        // Generate mini calendar for the month
        const firstDay = new Date(year, index, 1);
        const lastDay = new Date(year, index + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDayOfWeek = firstDay.getDay();
        
        // Add day headers
        const dayHeaders = ['M', 'S', 'S', 'R', 'K', 'J', 'S'];
        dayHeaders.forEach(day => {
            const dayHeader = document.createElement('div');
            dayHeader.className = 'mini-day-header';
            dayHeader.textContent = day;
            miniCalendar.appendChild(dayHeader);
        });
        
        // Add empty cells for days before month starts
        for (let i = 0; i < startingDayOfWeek; i++) {
            const emptyCell = document.createElement('div');
            emptyCell.className = 'mini-day empty';
            miniCalendar.appendChild(emptyCell);
        }
        
        // Add days of the month
        for (let day = 1; day <= daysInMonth; day++) {
            const dayCell = document.createElement('div');
            dayCell.className = 'mini-day';
            dayCell.textContent = day;
            dayCell.addEventListener('click', () => {
                currentMonth = new Date(year, index, day);
                switchView('month');
            });
            miniCalendar.appendChild(dayCell);
        }
        
        monthCard.appendChild(miniCalendar);
        yearGrid.appendChild(monthCard);
    });
}

async function loadDayAssignments(date) {
    // Load assignments for specific day
    // This would fetch from API for the specific date
    console.log('Loading day assignments for:', date);
}

async function loadWeekAssignments(startDate) {
    // Load assignments for the week
    // This would fetch from API for the week range
    console.log('Loading week assignments starting:', startDate);
}

// Load daftar cabang dari database
async function loadCabangList() {
    try {
        const response = await fetch('api_shift_calendar.php?action=get_cabang');
        const result = await response.json();
        
        if (result.status === 'success') {
            const cabangSelect = document.getElementById('cabang-select');
            if (cabangSelect) {
                // Clear existing options except first
                while (cabangSelect.options.length > 1) {
                    cabangSelect.remove(1);
                }
                
                // Group by nama_cabang
                const cabangGroups = {};
                result.data.forEach(cabang => {
                    if (!cabangGroups[cabang.nama_cabang]) {
                        cabangGroups[cabang.nama_cabang] = [];
                    }
                    cabangGroups[cabang.nama_cabang].push(cabang);
                });
                
                // Add options grouped by cabang
                Object.keys(cabangGroups).forEach(namaCabang => {
                    cabangGroups[namaCabang].forEach(cabang => {
                        const option = document.createElement('option');
                        option.value = cabang.id;
                        option.textContent = `${cabang.nama_cabang} - ${cabang.nama_shift} (${cabang.jam_masuk}-${cabang.jam_keluar})`;
                        cabangSelect.appendChild(option);
                    });
                });
                
                // Load all pegawai initially
                loadPegawaiList();
            }
        }
    } catch (error) {
        console.error('Error loading cabang list:', error);
    }
}

// Load daftar pegawai
async function loadPegawaiList() {
    try {
        let url = 'api_shift_calendar.php?action=get_pegawai';
        if (currentCabangId) {
            url += `&cabang_id=${currentCabangId}`;
        }
        
        const response = await fetch(url);
        const result = await response.json();
        
        if (result.status === 'success') {
            pegawaiList = result.data;
            
            // Update employee selector
            const employeeSelect = document.getElementById('employee-select');
            if (employeeSelect) {
                // Clear existing options except first
                while (employeeSelect.options.length > 1) {
                    employeeSelect.remove(1);
                }
                
                // Add pegawai options
                pegawaiList.forEach(pegawai => {
                    const option = document.createElement('option');
                    option.value = pegawai.id;
                    option.textContent = `${pegawai.name} - ${pegawai.posisi || 'N/A'}`;
                    employeeSelect.appendChild(option);
                });
            }
        }
    } catch (error) {
        console.error('Error loading pegawai list:', error);
    }
}

// Load data shift untuk bulan tertentu
async function loadMonthData(date) {
    try {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const monthStr = `${year}-${month}`;
        
        let url = `api_shift_calendar.php?action=get_assignments&month=${monthStr}`;
        if (currentCabangId) {
            url += `&cabang_id=${currentCabangId}`;
        }
        
        const response = await fetch(url);
        const result = await response.json();
        
        if (result.status === 'success') {
            shiftAssignments = result.data;
            
            // Update navigation label
            updateNavigationLabel(date);
            
            // Render calendar with data
            renderCalendarWithData(date);
        }
    } catch (error) {
        console.error('Error loading month data:', error);
    }
}

// Update navigation label
function updateNavigationLabel(date) {
    const currentNav = document.getElementById('current-nav');
    if (currentNav) {
        const options = { year: 'numeric', month: 'long' };
        currentNav.textContent = date.toLocaleDateString('id-ID', options);
    }
}

// Render kalender dengan data dari database
function renderCalendarWithData(date) {
    const calendarBody = document.getElementById('calendar-body');
    if (!calendarBody) return;
    
    calendarBody.innerHTML = '';
    
    const year = date.getFullYear();
    const month = date.getMonth();
    
    // Get first day of month and total days
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const totalDays = lastDay.getDate();
    
    // Start from Monday (1 = Monday in getDay with offset)
    let dayOfWeek = firstDay.getDay();
    dayOfWeek = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Convert Sunday (0) to 6
    
    let currentDay = 1;
    let row = document.createElement('tr');
    
    // Fill empty cells before first day
    for (let i = 0; i < dayOfWeek; i++) {
        const cell = document.createElement('td');
        cell.className = 'empty-cell';
        row.appendChild(cell);
    }
    
    // Fill days of month
    while (currentDay <= totalDays) {
        const cell = document.createElement('td');
        cell.className = 'calendar-day';
        
        const dayNumber = document.createElement('div');
        dayNumber.className = 'day-number';
        dayNumber.textContent = currentDay;
        cell.appendChild(dayNumber);
        
        // Check if there are assignments for this day
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(currentDay).padStart(2, '0')}`;
        const dayAssignments = shiftAssignments.filter(a => a.tanggal_shift === dateStr);
        
        if (dayAssignments.length > 0) {
            const assignmentContainer = document.createElement('div');
            assignmentContainer.className = 'shift-assignments';
            
            dayAssignments.forEach(assignment => {
                const assignmentDiv = document.createElement('div');
                assignmentDiv.className = 'shift-assignment';
                assignmentDiv.textContent = `${assignment.nama_lengkap} - ${assignment.nama_shift}`;
                assignmentDiv.title = `${assignment.nama_cabang}\n${assignment.jam_masuk} - ${assignment.jam_keluar}`;
                assignmentDiv.dataset.assignmentId = assignment.id;
                
                // Add click handler untuk edit/delete
                assignmentDiv.addEventListener('click', function(e) {
                    e.stopPropagation();
                    showAssignmentMenu(assignment, assignmentDiv);
                });
                
                assignmentContainer.appendChild(assignmentDiv);
            });
            
            cell.appendChild(assignmentContainer);
        }
        
        // Add click handler untuk add assignment
        cell.addEventListener('click', function() {
            if (!currentCabangId) {
                alert('Silakan pilih cabang terlebih dahulu');
                return;
            }
            showAddAssignmentDialog(dateStr);
        });
        
        row.appendChild(cell);
        
        // Start new row after Saturday
        if ((dayOfWeek + currentDay) % 7 === 0) {
            calendarBody.appendChild(row);
            row = document.createElement('tr');
        }
        
        currentDay++;
    }
    
    // Fill remaining cells
    if (row.children.length > 0) {
        while (row.children.length < 7) {
            const cell = document.createElement('td');
            cell.className = 'empty-cell';
            row.appendChild(cell);
        }
        calendarBody.appendChild(row);
    }
}

// Show dialog untuk menambah assignment
function showAddAssignmentDialog(dateStr) {
    const employeeSelect = document.getElementById('employee-select');
    
    if (!employeeSelect || !employeeSelect.value) {
        alert('Silakan pilih karyawan terlebih dahulu');
        return;
    }
    
    const userId = employeeSelect.value;
    const employeeName = employeeSelect.options[employeeSelect.selectedIndex].text;
    
    if (confirm(`Assign shift ke ${employeeName} pada tanggal ${dateStr}?`)) {
        createAssignment(userId, dateStr);
    }
}

// Create shift assignment
async function createAssignment(userId, dateStr) {
    try {
        const response = await fetch('api_shift_calendar.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                action: 'create',
                user_id: userId,
                cabang_id: currentCabangId,
                tanggal_shift: dateStr
            })
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            alert('Shift berhasil di-assign!');
            loadMonthData(currentMonth);
        } else {
            alert('Error: ' + result.message);
        }
    } catch (error) {
        console.error('Error creating assignment:', error);
        alert('Terjadi kesalahan saat membuat assignment');
    }
}

// Show menu untuk assignment (edit/delete)
function showAssignmentMenu(assignment, element) {
    const menu = confirm(`${assignment.nama_lengkap}\n${assignment.nama_cabang} - ${assignment.nama_shift}\n${assignment.jam_masuk} - ${assignment.jam_keluar}\n\nHapus assignment ini?`);
    
    if (menu) {
        deleteAssignment(assignment.id);
    }
}

// Delete shift assignment
async function deleteAssignment(assignmentId) {
    try {
        const response = await fetch('api_shift_calendar.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                action: 'delete',
                id: assignmentId
            })
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            alert('Shift berhasil dihapus!');
            loadMonthData(currentMonth);
        } else {
            alert('Error: ' + result.message);
        }
    } catch (error) {
        console.error('Error deleting assignment:', error);
        alert('Terjadi kesalahan saat menghapus assignment');
    }
}

// Switch between different calendar views
function switchView(view) {
    currentView = view;
    
    // Hide all views
    document.getElementById('month-view').style.display = 'none';
    document.getElementById('week-view').style.display = 'none';
    document.getElementById('day-view').style.display = 'none';
    document.getElementById('year-view').style.display = 'none';
    
    // Remove active class from all view buttons
    document.querySelectorAll('.view-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected view and activate button
    switch(view) {
        case 'day':
            document.getElementById('day-view').style.display = 'block';
            document.getElementById('view-day').classList.add('active');
            updateNavigationLabels('Hari Sebelumnya', 'Hari Berikutnya');
            renderDayView();
            break;
        case 'week':
            document.getElementById('week-view').style.display = 'block';
            document.getElementById('view-week').classList.add('active');
            updateNavigationLabels('Minggu Sebelumnya', 'Minggu Berikutnya');
            renderWeekView();
            break;
        case 'month':
            document.getElementById('month-view').style.display = 'block';
            document.getElementById('view-month').classList.add('active');
            updateNavigationLabels('Bulan Sebelumnya', 'Bulan Berikutnya');
            loadMonthData(currentMonth);
            break;
        case 'year':
            document.getElementById('year-view').style.display = 'block';
            document.getElementById('view-year').classList.add('active');
            updateNavigationLabels('Tahun Sebelumnya', 'Tahun Berikutnya');
            renderYearView();
            break;
    }
}

function updateNavigationLabels(prevLabel, nextLabel) {
    const prevLabelEl = document.getElementById('prev-label');
    const nextLabelEl = document.getElementById('next-label');
    if (prevLabelEl) prevLabelEl.textContent = prevLabel;
    if (nextLabelEl) nextLabelEl.textContent = nextLabel;
}

function renderDayView() {
    const dayView = document.getElementById('day-calendar');
    if (!dayView) return;
    
    // Update day date display
    const dayDate = document.getElementById('day-date');
    if (dayDate) {
        dayDate.textContent = currentMonth.toLocaleDateString('id-ID', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
    }
    
    // Render time slots for the day
    const timeColumn = document.getElementById('day-time-column');
    const dayContent = document.getElementById('day-content');
    
    if (timeColumn && dayContent) {
        timeColumn.innerHTML = '';
        dayContent.innerHTML = '';
        
        // Generate 24 hour time slots
        for (let hour = 0; hour < 24; hour++) {
            const timeSlot = document.createElement('div');
            timeSlot.className = 'time-slot';
            timeSlot.textContent = `${hour.toString().padStart(2, '0')}:00`;
            timeColumn.appendChild(timeSlot);
            
            const contentSlot = document.createElement('div');
            contentSlot.className = 'day-slot';
            contentSlot.dataset.hour = hour;
            dayContent.appendChild(contentSlot);
        }
        
        // Load assignments for this day
        loadDayAssignments(currentMonth);
    }
}

function renderWeekView() {
    const weekView = document.getElementById('week-calendar');
    if (!weekView) return;
    
    // Get start of week (Sunday)
    const startOfWeek = new Date(currentMonth);
    startOfWeek.setDate(currentMonth.getDate() - currentMonth.getDay());
    
    // Update week range display
    const weekRange = document.getElementById('week-range');
    const endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 6);
    
    if (weekRange) {
        weekRange.textContent = `${startOfWeek.toLocaleDateString('id-ID')} - ${endOfWeek.toLocaleDateString('id-ID')}`;
    }
    
    // Render time column
    const timeColumn = document.getElementById('time-column');
    const daysColumn = document.getElementById('days-column');
    
    if (timeColumn && daysColumn) {
        timeColumn.innerHTML = '';
        daysColumn.innerHTML = '';
        
        // Generate time slots
        for (let hour = 0; hour < 24; hour++) {
            const timeSlot = document.createElement('div');
            timeSlot.className = 'time-slot';
            timeSlot.textContent = `${hour.toString().padStart(2, '0')}:00`;
            timeColumn.appendChild(timeSlot);
        }
        
        // Generate day columns
        const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
        for (let i = 0; i < 7; i++) {
            const dayCol = document.createElement('div');
            dayCol.className = 'day-column';
            
            const dayHeader = document.createElement('div');
            dayHeader.className = 'day-header';
            const currentDay = new Date(startOfWeek);
            currentDay.setDate(startOfWeek.getDate() + i);
            dayHeader.textContent = `${days[i]}, ${currentDay.getDate()}`;
            dayCol.appendChild(dayHeader);
            
            // Add time slots for each day
            for (let hour = 0; hour < 24; hour++) {
                const slot = document.createElement('div');
                slot.className = 'week-slot';
                slot.dataset.date = currentDay.toISOString().split('T')[0];
                slot.dataset.hour = hour;
                dayCol.appendChild(slot);
            }
            
            daysColumn.appendChild(dayCol);
        }
        
        // Load assignments for this week
        loadWeekAssignments(startOfWeek);
    }
}

function renderYearView() {
    const yearGrid = document.getElementById('year-grid');
    if (!yearGrid) return;
    
    yearGrid.innerHTML = '';
    
    const year = currentMonth.getFullYear();
    const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                   'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
    
    months.forEach((monthName, index) => {
        const monthCard = document.createElement('div');
        monthCard.className = 'month-card';
        
        const monthHeader = document.createElement('h3');
        monthHeader.textContent = monthName;
        monthCard.appendChild(monthHeader);
        
        const miniCalendar = document.createElement('div');
        miniCalendar.className = 'mini-calendar';
        
        // Generate mini calendar for the month
        const firstDay = new Date(year, index, 1);
        const lastDay = new Date(year, index + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDayOfWeek = firstDay.getDay();
        
        // Add day headers
        const dayHeaders = ['M', 'S', 'S', 'R', 'K', 'J', 'S'];
        dayHeaders.forEach(day => {
            const dayHeader = document.createElement('div');
            dayHeader.className = 'mini-day-header';
            dayHeader.textContent = day;
            miniCalendar.appendChild(dayHeader);
        });
        
        // Add empty cells for days before month starts
        for (let i = 0; i < startingDayOfWeek; i++) {
            const emptyCell = document.createElement('div');
            emptyCell.className = 'mini-day empty';
            miniCalendar.appendChild(emptyCell);
        }
        
        // Add days of the month
        for (let day = 1; day <= daysInMonth; day++) {
            const dayCell = document.createElement('div');
            dayCell.className = 'mini-day';
            dayCell.textContent = day;
            dayCell.addEventListener('click', () => {
                currentMonth = new Date(year, index, day);
                switchView('month');
            });
            miniCalendar.appendChild(dayCell);
        }
        
        monthCard.appendChild(miniCalendar);
        yearGrid.appendChild(monthCard);
    });
}

async function loadDayAssignments(date) {
    // Load assignments for specific day
    // This would fetch from API for the specific date
    console.log('Loading day assignments for:', date);
}

async function loadWeekAssignments(startDate) {
    // Load assignments for the week
    // This would fetch from API for the week range
    console.log('Loading week assignments starting:', startDate);
}

// Load daftar cabang dari database
async function loadCabangList() {
    try {
        const response = await fetch('api_shift_calendar.php?action=get_cabang');
        const result = await response.json();
        
        if (result.status === 'success') {
            const cabangSelect = document.getElementById('cabang-select');
            if (cabangSelect) {
                // Clear existing options except first
                while (cabangSelect.options.length > 1) {
                    cabangSelect.remove(1);
                }
                
                // Group by nama_cabang
                const cabangGroups = {};
                result.data.forEach(cabang => {
                    if (!cabangGroups[cabang.nama_cabang]) {
                        cabangGroups[cabang.nama_cabang] = [];
                    }
                    cabangGroups[cabang.nama_cabang].push(cabang);
                });
                
                // Add options grouped by cabang
                Object.keys(cabangGroups).forEach(namaCabang => {
                    cabangGroups[namaCabang].forEach(cabang => {
                        const option = document.createElement('option');
                        option.value = cabang.id;
                        option.textContent = `${cabang.nama_cabang} - ${cabang.nama_shift} (${cabang.jam_masuk}-${cabang.jam_keluar})`;
                        cabangSelect.appendChild(option);
                    });
                });
                
                // Load all pegawai initially
                loadPegawaiList();
            }
        }
    } catch (error) {
        console.error('Error loading cabang list:', error);
    }
}

// Load daftar pegawai
async function loadPegawaiList() {
    try {
        let url = 'api_shift_calendar.php?action=get_pegawai';
        if (currentCabangId) {
            url += `&cabang_id=${currentCabangId}`;
        }
        
        const response = await fetch(url);
        const result = await response.json();
        
        if (result.status === 'success') {
            pegawaiList = result.data;
            
            // Update employee selector
            const employeeSelect = document.getElementById('employee-select');
            if (employeeSelect) {
                // Clear existing options except first
                while (employeeSelect.options.length > 1) {
                    employeeSelect.remove(1);
                }
                
                // Add pegawai options
                pegawaiList.forEach(pegawai => {
                    const option = document.createElement('option');
                    option.value = pegawai.id;
                    option.textContent = `${pegawai.name} - ${pegawai.posisi || 'N/A'}`;
                    employeeSelect.appendChild(option);
                });
            }
        }
    } catch (error) {
        console.error('Error loading pegawai list:', error);
    }
}

// Load data shift untuk bulan tertentu
async function loadMonthData(date) {
    try {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const monthStr = `${year}-${month}`;
        
        let url = `api_shift_calendar.php?action=get_assignments&month=${monthStr}`;
        if (currentCabangId) {
            url += `&cabang_id=${currentCabangId}`;
        }
        
        const response = await fetch(url);
        const result = await response.json();
        
        if (result.status === 'success') {
            shiftAssignments = result.data;
            
            // Update navigation label
            updateNavigationLabel(date);
            
            // Render calendar with data
            renderCalendarWithData(date);
        }
    } catch (error) {
        console.error('Error loading month data:', error);
    }
}

// Update navigation label
function updateNavigationLabel(date) {
    const currentNav = document.getElementById('current-nav');
    if (currentNav) {
        const options = { year: 'numeric', month: 'long' };
        currentNav.textContent = date.toLocaleDateString('id-ID', options);
    }
}

// Render kalender dengan data dari database
function renderCalendarWithData(date) {
    const calendarBody = document.getElementById('calendar-body');
    if (!calendarBody) return;
    
    calendarBody.innerHTML = '';
    
    const year = date.getFullYear();
    const month = date.getMonth();
    
    // Get first day of month and total days
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const totalDays = lastDay.getDate();
    
    // Start from Monday (1 = Monday in getDay with offset)
    let dayOfWeek = firstDay.getDay();
    dayOfWeek = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Convert Sunday (0) to 6
    
    let currentDay = 1;
    let row = document.createElement('tr');
    
    // Fill empty cells before first day
    for (let i = 0; i < dayOfWeek; i++) {
        const cell = document.createElement('td');
        cell.className = 'empty-cell';
        row.appendChild(cell);
    }
    
    // Fill days of month
    while (currentDay <= totalDays) {
        const cell = document.createElement('td');
        cell.className = 'calendar-day';
        
        const dayNumber = document.createElement('div');
        dayNumber.className = 'day-number';
        dayNumber.textContent = currentDay;
        cell.appendChild(dayNumber);
        
        // Check if there are assignments for this day
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(currentDay).padStart(2, '0')}`;
        const dayAssignments = shiftAssignments.filter(a => a.tanggal_shift === dateStr);
        
        if (dayAssignments.length > 0) {
            const assignmentContainer = document.createElement('div');
            assignmentContainer.className = 'shift-assignments';
            
            dayAssignments.forEach(assignment => {
                const assignmentDiv = document.createElement('div');
                assignmentDiv.className = 'shift-assignment';
                assignmentDiv.textContent = `${assignment.nama_lengkap} - ${assignment.nama_shift}`;
                assignmentDiv.title = `${assignment.nama_cabang}\n${assignment.jam_masuk} - ${assignment.jam_keluar}`;
                assignmentDiv.dataset.assignmentId = assignment.id;
                
                // Add click handler untuk edit/delete
                assignmentDiv.addEventListener('click', function(e) {
                    e.stopPropagation();
                    showAssignmentMenu(assignment, assignmentDiv);
                });
                
                assignmentContainer.appendChild(assignmentDiv);
            });
            
            cell.appendChild(assignmentContainer);
        }
        
        // Add click handler untuk add assignment
        cell.addEventListener('click', function() {
            if (!currentCabangId) {
                alert('Silakan pilih cabang terlebih dahulu');
                return;
            }
            showAddAssignmentDialog(dateStr);
        });
        
        row.appendChild(cell);
        
        // Start new row after Saturday
        if ((dayOfWeek + currentDay) % 7 === 0) {
            calendarBody.appendChild(row);
            row = document.createElement('tr');
        }
        
        currentDay++;
    }
    
    // Fill remaining cells
    if (row.children.length > 0) {
        while (row.children.length < 7) {
            const cell = document.createElement('td');
            cell.className = 'empty-cell';
            row.appendChild(cell);
        }
        calendarBody.appendChild(row);
    }
}

// Show dialog untuk menambah assignment
function showAddAssignmentDialog(dateStr) {
    const employeeSelect = document.getElementById('employee-select');
    
    if (!employeeSelect || !employeeSelect.value) {
        alert('Silakan pilih karyawan terlebih dahulu');
        return;
    }
    
    const userId = employeeSelect.value;
    const employeeName = employeeSelect.options[employeeSelect.selectedIndex].text;
    
    if (confirm(`Assign shift ke ${employeeName} pada tanggal ${dateStr}?`)) {
        createAssignment(userId, dateStr);
    }
}

// Create shift assignment
async function createAssignment(userId, dateStr) {
    try {
        const response = await fetch('api_shift_calendar.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                action: 'create',
                user_id: userId,
                cabang_id: currentCabangId,
                tanggal_shift: dateStr
            })
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            alert('Shift berhasil di-assign!');
            loadMonthData(currentMonth);
        } else {
            alert('Error: ' + result.message);
        }
    } catch (error) {
        console.error('Error creating assignment:', error);
        alert('Terjadi kesalahan saat membuat assignment');
    }
}

// Show menu untuk assignment (edit/delete)
function showAssignmentMenu(assignment, element) {
    const menu = confirm(`${assignment.nama_lengkap}\n${assignment.nama_cabang} - ${assignment.nama_shift}\n${assignment.jam_masuk} - ${assignment.jam_keluar}\n\nHapus assignment ini?`);
    
    if (menu) {
        deleteAssignment(assignment.id);
    }
}

// Delete shift assignment
async function deleteAssignment(assignmentId) {
    try {
        const response = await fetch('api_shift_calendar.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                action: 'delete',
                id: assignmentId
            })
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            alert('Shift berhasil dihapus!');
            loadMonthData(currentMonth);
        } else {
            alert('Error: ' + result.message);
        }
    } catch (error) {
        console.error('Error deleting assignment:', error);
        alert('Terjadi kesalahan saat menghapus assignment');
    }
}

// Switch between different calendar views
function switchView(view) {
    currentView = view;
    
    // Hide all views
    document.getElementById('month-view').style.display = 'none';
    document.getElementById('week-view').style.display = 'none';
    document.getElementById('day-view').style.display = 'none';
    document.getElementById('year-view').style.display = 'none';
    
    // Remove active class from all view buttons
    document.querySelectorAll('.view-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected view and activate button
    switch(view) {
        case 'day':
            document.getElementById('day-view').style.display = 'block';
            document.getElementById('view-day').classList.add('active');
            updateNavigationLabels('Hari Sebelumnya', 'Hari Berikutnya');
            renderDayView();
            break;
        case 'week':
            document.getElementById('week-view').style.display = 'block';
            document.getElementById('view-week').classList.add('active');
            updateNavigationLabels('Minggu Sebelumnya', 'Minggu Berikutnya');
            renderWeekView();
            break;
        case 'month':
            document.getElementById('month-view').style.display = 'block';
            document.getElementById('view-month').classList.add('active');
            updateNavigationLabels('Bulan Sebelumnya', 'Bulan Berikutnya');
            loadMonthData(currentMonth);
            break;
        case 'year':
            document.getElementById('year-view').style.display = 'block';
            document.getElementById('view-year').classList.add('active');
            updateNavigationLabels('Tahun Sebelumnya', 'Tahun Berikutnya');
            renderYearView();
            break;
    }
}

function updateNavigationLabels(prevLabel, nextLabel) {
    const prevLabelEl = document.getElementById('prev-label');
    const nextLabelEl = document.getElementById('next-label');
    if (prevLabelEl) prevLabelEl.textContent = prevLabel;
    if (nextLabelEl) nextLabelEl.textContent = nextLabel;
}

function renderDayView() {
    const dayView = document.getElementById('day-calendar');
    if (!dayView) return;
    
    // Update day date display
    const dayDate = document.getElementById('day-date');
    if (dayDate) {
        dayDate.textContent = currentMonth.toLocaleDateString('id-ID', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
    }
    
    // Render time slots for the day
    const timeColumn = document.getElementById('day-time-column');
    const dayContent = document.getElementById('day-content');
    
    if (timeColumn && dayContent) {
        timeColumn.innerHTML = '';
        dayContent.innerHTML = '';
        
        // Generate 24 hour time slots
        for (let hour = 0; hour < 24; hour++) {
            const timeSlot = document.createElement('div');
            timeSlot.className = 'time-slot';
            timeSlot.textContent = `${hour.toString().padStart(2, '0')}:00`;
            timeColumn.appendChild(timeSlot);
            
            const contentSlot = document.createElement('div');
            contentSlot.className = 'day-slot';
            contentSlot.dataset.hour = hour;
            dayContent.appendChild(contentSlot);
        }
        
        // Load assignments for this day
        loadDayAssignments(currentMonth);
    }
}

function renderWeekView() {
    const weekView = document.getElementById('week-calendar');
    if (!weekView) return;
    
    // Get start of week (Sunday)
    const startOfWeek = new Date(currentMonth);
    startOfWeek.setDate(currentMonth.getDate() - currentMonth.getDay());
    
    // Update week range display
    const weekRange = document.getElementById('week-range');
    const endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 6);
    
    if (weekRange) {
        weekRange.textContent = `${startOfWeek.toLocaleDateString('id-ID')} - ${endOfWeek.toLocaleDateString('id-ID')}`;
    }
    
    // Render time column
    const timeColumn = document.getElementById('time-column');
    const daysColumn = document.getElementById('days-column');
    
    if (timeColumn && daysColumn) {
        timeColumn.innerHTML = '';
        daysColumn.innerHTML = '';
        
        // Generate time slots
        for (let hour = 0; hour < 24; hour++) {
            const timeSlot = document.createElement('div');
            timeSlot.className = 'time-slot';
            timeSlot.textContent = `${hour.toString().padStart(2, '0')}:00`;
            timeColumn.appendChild(timeSlot);
        }
        
        // Generate day columns
        const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
        for (let i = 0; i < 7; i++) {
            const dayCol = document.createElement('div');
            dayCol.className = 'day-column';
            
            const dayHeader = document.createElement('div');
            dayHeader.className = 'day-header';
            const currentDay = new Date(startOfWeek);
            currentDay.setDate(startOfWeek.getDate() + i);
            dayHeader.textContent = `${days[i]}, ${currentDay.getDate()}`;
            dayCol.appendChild(dayHeader);
            
            // Add time slots for each day
            for (let hour = 0; hour < 24; hour++) {
                const slot = document.createElement('div');
                slot.className = 'week-slot';
                slot.dataset.date = currentDay.toISOString().split('T')[0];
                slot.dataset.hour = hour;
                dayCol.appendChild(slot);
            }
            
            daysColumn.appendChild(dayCol);
        }
        
        // Load assignments for this week
        loadWeekAssignments(startOfWeek);
    }
}

function renderYearView() {
    const yearGrid = document.getElementById('year-grid');
    if (!yearGrid) return;
    
    yearGrid.innerHTML = '';
    
    const year = currentMonth.getFullYear();
    const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                   'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
    
    months.forEach((monthName, index) => {
        const monthCard = document.createElement('div');
        monthCard.className = 'month-card';
        
        const monthHeader = document.createElement('h3');
        monthHeader.textContent = monthName;
        monthCard.appendChild(monthHeader);
        
        const miniCalendar = document.createElement('div');
        miniCalendar.className = 'mini-calendar';
        
        // Generate mini calendar for the month
        const firstDay = new Date(year, index, 1);
        const lastDay = new Date(year, index + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDayOfWeek = firstDay.getDay();
        
        // Add day headers
        const dayHeaders = ['M', 'S', 'S', 'R', 'K', 'J', 'S'];
        dayHeaders.forEach(day => {
            const dayHeader = document.createElement('div');
            dayHeader.className = 'mini-day-header';
            dayHeader.textContent = day;
            miniCalendar.appendChild(dayHeader);
        });
        
        // Add empty cells for days before month starts
        for (let i = 0; i < startingDayOfWeek; i++) {
            const emptyCell = document.createElement('div');
            emptyCell.className = 'mini-day empty';
            miniCalendar.appendChild(emptyCell);
        }
        
        // Add days of the month
        for (let day = 1; day <= daysInMonth; day++) {
            const dayCell = document.createElement('div');
            dayCell.className = 'mini-day';
            dayCell.textContent = day;
            dayCell.addEventListener('click', () => {
                currentMonth = new Date(year, index, day);
                switchView('month');
            });
            miniCalendar.appendChild(dayCell);
        }
        
        monthCard.appendChild(miniCalendar);
        yearGrid.appendChild(monthCard);
    });
}

async function loadDayAssignments(date) {
    // Load assignments for specific day
    // This would fetch from API for the specific date
    console.log('Loading day assignments for:', date);
}

async function loadWeekAssignments(startDate) {
    // Load assignments for the week
    // This would fetch from API for the week range
    console.log('Loading week assignments starting:', startDate);
}

// Load daftar cabang dari database
async function loadCabangList() {
    try {
        const response = await fetch('api_shift_calendar.php?action=get_cabang');
        const result = await response.json();
        
        if (result.status === 'success') {
            const cabangSelect = document.getElementById('cabang-select');
            if (cabangSelect) {
                // Clear existing options except first
                while (cabangSelect.options.length > 1) {
                    cabangSelect.remove(1);
                }
                
                // Group by nama_cabang
                const cabangGroups = {};
                result.data.forEach(cabang => {
                    if (!cabangGroups[cabang.nama_cabang]) {
                        cabangGroups[cabang.nama_cabang] = [];
                    }
                    cabangGroups[cabang.nama_cabang].push(cabang);
                });
                
                // Add options grouped by cabang
                Object.keys(cabangGroups).forEach(namaCabang => {
                    cabangGroups[namaCabang].forEach(cabang => {
                        const option = document.createElement('option');
                        option.value = cabang.id;
                        option.textContent = `${cabang.nama_cabang} - ${cabang.nama_shift} (${cabang.jam_masuk}-${cabang.jam_keluar})`;
                        cabangSelect.appendChild(option);
                    });
                });
                
                // Load all pegawai initially
                loadPegawaiList();
            }
        }
    } catch (error) {
        console.error('Error loading cabang list:', error);
    }
}

// Load daftar pegawai
async function loadPegawaiList() {
    try {
        let url = 'api_shift_calendar.php?action=get_pegawai';
        if (currentCabangId) {
            url += `&cabang_id=${currentCabangId}`;
        }
        
        const response = await fetch(url);
        const result = await response.json();
        
        if (result.status === 'success') {
            pegawaiList = result.data;
            
            // Update employee selector
            const employeeSelect = document.getElementById('employee-select');
            if (employeeSelect) {
                // Clear existing options except first
                while (employeeSelect.options.length > 1) {
                    employeeSelect.remove(1);
                }
                
                // Add pegawai options
                pegawaiList.forEach(pegawai => {
                    const option = document.createElement('option');
                    option.value = pegawai.id;
                    option.textContent = `${pegawai.name} - ${pegawai.posisi || 'N/A'}`;
                    employeeSelect.appendChild(option);
                });
            }
        }
    } catch (error) {
        console.error('Error loading pegawai list:', error);
    }
}

// Load data shift untuk bulan tertentu
async function loadMonthData(date) {
    try {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const monthStr = `${year}-${month}`;
        
        let url = `api_shift_calendar.php?action=get_assignments&month=${monthStr}`;
        if (currentCabangId) {
            url += `&cabang_id=${currentCabangId}`;
        }
        
        const response = await fetch(url);
        const result = await response.json();
        
        if (result.status === 'success') {
            shiftAssignments = result.data;
            
            // Update navigation label
            updateNavigationLabel(date);
            
            // Render calendar with data
            renderCalendarWithData(date);
        }
    } catch (error) {
        console.error('Error loading month data:', error);
    }
}

// Update navigation label
function updateNavigationLabel(date) {
    const currentNav = document.getElementById('current-nav');
    if (currentNav) {
        const options = { year: 'numeric', month: 'long' };
        currentNav.textContent = date.toLocaleDateString('id-ID', options);
    }
}

// Render kalender dengan data dari database
function renderCalendarWithData(date) {
    const calendarBody = document.getElementById('calendar-body');
    if (!calendarBody) return;
    
    calendarBody.innerHTML = '';
    
    const year = date.getFullYear();
    const month = date.getMonth();
    
    // Get first day of month and total days
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const totalDays = lastDay.getDate();
    
    // Start from Monday (1 = Monday in getDay with offset)
    let dayOfWeek = firstDay.getDay();
    dayOfWeek = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Convert Sunday (0) to 6
    
    let currentDay = 1;
    let row = document.createElement('tr');
    
    // Fill empty cells before first day
    for (let i = 0; i < dayOfWeek; i++) {
        const cell = document.createElement('td');
        cell.className = 'empty-cell';
        row.appendChild(cell);
    }
    
    // Fill days of month
    while (currentDay <= totalDays) {
        const cell = document.createElement('td');
        cell.className = 'calendar-day';
        
        const dayNumber = document.createElement('div');
        dayNumber.className = 'day-number';
        dayNumber.textContent = currentDay;
        cell.appendChild(dayNumber);
        
        // Check if there are assignments for this day
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(currentDay).padStart(2, '0')}`;
        const dayAssignments = shiftAssignments.filter(a => a.tanggal_shift === dateStr);
        
        if (dayAssignments.length > 0) {
            const assignmentContainer = document.createElement('div');
            assignmentContainer.className = 'shift-assignments';
            
            dayAssignments.forEach(assignment => {
                const assignmentDiv = document.createElement('div');
                assignmentDiv.className = 'shift-assignment';
                assignmentDiv.textContent = `${assignment.nama_lengkap} - ${assignment.nama_shift}`;
                assignmentDiv.title = `${assignment.nama_cabang}\n${assignment.jam_masuk} - ${assignment.jam_keluar}`;
                assignmentDiv.dataset.assignmentId = assignment.id;
                
                // Add click handler untuk edit/delete
                assignmentDiv.addEventListener('click', function(e) {
                    e.stopPropagation();
                    showAssignmentMenu(assignment, assignmentDiv);
                });
                
                assignmentContainer.appendChild(assignmentDiv);
            });
            
            cell.appendChild(assignmentContainer);
        }
        
        // Add click handler untuk add assignment
        cell.addEventListener('click', function() {
            if (!currentCabangId) {
                alert('Silakan pilih cabang terlebih dahulu');
                return;
            }
            showAddAssignmentDialog(dateStr);
        });
        
        row.appendChild(cell);
        
        // Start new row after Saturday
        if ((dayOfWeek + currentDay) % 7 === 0) {
            calendarBody.appendChild(row);
            row = document.createElement('tr');
        }
        
        currentDay++;
    }
    
    // Fill remaining cells
    if (row.children.length > 0) {
        while (row.children.length < 7) {
            const cell = document.createElement('td');
            cell.className = 'empty-cell';
            row.appendChild(cell);
        }
        calendarBody.appendChild(row);
    }
}

// Show dialog untuk menambah assignment
function showAddAssignmentDialog(dateStr) {
    const employeeSelect = document.getElementById('employee-select');
    
    if (!employeeSelect || !employeeSelect.value) {
        alert('Silakan pilih karyawan terlebih dahulu');
        return;
    }
    
    const userId = employeeSelect.value;
    const employeeName = employeeSelect.options[employeeSelect.selectedIndex].text;
    
    if (confirm(`Assign shift ke ${employeeName} pada tanggal ${dateStr}?`)) {
        createAssignment(userId, dateStr);
    }
}

// Create shift assignment
async function createAssignment(userId, dateStr) {
    try {
        const response = await fetch('api_shift_calendar.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                action: 'create',
                user_id: userId,
                cabang_id: currentCabangId,
                tanggal_shift: dateStr
            })
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            alert('Shift berhasil di-assign!');
            loadMonthData(currentMonth);
        } else {
            alert('Error: ' + result.message);
        }
    } catch (error) {
        console.error('Error creating assignment:', error);
        alert('Terjadi kesalahan saat membuat assignment');
    }
}

// Show menu untuk assignment (edit/delete)
function showAssignmentMenu(assignment, element) {
    const menu = confirm(`${assignment.nama_lengkap}\n${assignment.nama_cabang} - ${assignment.nama_shift}\n${assignment.jam_masuk} - ${assignment.jam_keluar}\n\nHapus assignment ini?`);
    
    if (menu) {
        deleteAssignment(assignment.id);
    }
}

// Delete shift assignment
async function deleteAssignment(assignmentId) {
    try {
        const response = await fetch('api_shift_calendar.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                action: 'delete',
                id: assignmentId
            })
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            alert('Shift berhasil dihapus!');
            loadMonthData(currentMonth);
        } else {
            alert('Error: ' + result.message);
        }
    } catch (error) {
        console.error('Error deleting assignment:', error);
        alert('Terjadi kesalahan saat menghapus assignment');
    }
}

// Switch between different calendar views
function switchView(view) {
    currentView = view;
    
    // Hide all views
    document.getElementById('month-view').style.display = 'none';
    document.getElementById('week-view').style.display = 'none';
    document.getElementById('day-view').style.display = 'none';
    document.getElementById('year-view').style.display = 'none';
    
    // Remove active class from all view buttons
    document.querySelectorAll('.view-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected view and activate button
    switch(view) {
        case 'day':
            document.getElementById('day-view').style.display = 'block';
            document.getElementById('view-day').classList.add('active');
            updateNavigationLabels('Hari Sebelumnya', 'Hari Berikutnya');
            renderDayView();
            break;
        case 'week':
            document.getElementById('week-view').style.display = 'block';
            document.getElementById('view-week').classList.add('active');
            updateNavigationLabels('Minggu Sebelumnya', 'Minggu Berikutnya');
            renderWeekView();
            break;
        case 'month':
            document.getElementById('month-view').style.display = 'block';
            document.getElementById('view-month').classList.add('active');
            updateNavigationLabels('Bulan Sebelumnya', 'Bulan Berikutnya');
            loadMonthData(currentMonth);
            break;
        case 'year':
            document.getElementById('year-view').style.display = 'block';
            document.getElementById('view-year').classList.add('active');
            updateNavigationLabels('Tahun Sebelumnya', 'Tahun Berikutnya');
            renderYearView();
            break;
    }
}

function updateNavigationLabels(prevLabel, nextLabel) {
    const prevLabelEl = document.getElementById('prev-label');
    const nextLabelEl = document.getElementById('next-label');
    if (prevLabelEl) prevLabelEl.textContent = prevLabel;
    if (nextLabelEl) nextLabelEl.textContent = nextLabel;
}

function renderDayView() {
    const dayView = document.getElementById('day-calendar');
    if (!dayView) return;
    
    // Update day date display
    const dayDate = document.getElementById('day-date');
    if (dayDate) {
        dayDate.textContent = currentMonth.toLocaleDateString('id-ID', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
    }
    
    // Render time slots for the day
    const timeColumn = document.getElementById('day-time-column');
    const dayContent = document.getElementById('day-content');
    
    if (timeColumn && dayContent) {
        timeColumn.innerHTML = '';
        dayContent.innerHTML = '';
        
        // Generate 24 hour time slots
        for (let hour = 0; hour < 24; hour++) {
            const timeSlot = document.createElement('div');
            timeSlot.className = 'time-slot';
            timeSlot.textContent = `${hour.toString().padStart(2, '0')}:00`;
            timeColumn.appendChild(timeSlot);
            
            const contentSlot = document.createElement('div');
            contentSlot.className = 'day-slot';
            contentSlot.dataset.hour = hour;
            dayContent.appendChild(contentSlot);
        }
        
        // Load assignments for this day
        loadDayAssignments(currentMonth);
    }
}

function renderWeekView() {
    const weekView = document.getElementById('week-calendar');
    if (!weekView) return;
    
    // Get start of week (Sunday)
    const startOfWeek = new Date(currentMonth);
    startOfWeek.setDate(currentMonth.getDate() - currentMonth.getDay());
    
    // Update week range display
    const weekRange = document.getElementById('week-range');
    const endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 6);
    
    if (weekRange) {
        weekRange.textContent = `${startOfWeek.toLocaleDateString('id-ID')} - ${endOfWeek.toLocaleDateString('id-ID')}`;
    }
    
    // Render time column
    const timeColumn = document.getElementById('time-column');
    const daysColumn = document.getElementById('days-column');
    
    if (timeColumn && daysColumn) {
        timeColumn.innerHTML = '';
        daysColumn.innerHTML = '';
        
        // Generate time slots
        for (let hour = 0; hour < 24; hour++) {
            const timeSlot = document.createElement('div');
            timeSlot.className = 'time-slot';
            timeSlot.textContent = `${hour.toString().padStart(2, '0')}:00`;
            timeColumn.appendChild(timeSlot);
        }
        
        // Generate day columns
        const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
        for (let i = 0; i < 7; i++) {
            const dayCol = document.createElement('div');
            dayCol.className = 'day-column';
            
            const dayHeader = document.createElement('div');
            dayHeader.className = 'day-header';
            const currentDay = new Date(startOfWeek);
            currentDay.setDate(startOfWeek.getDate() + i);
            dayHeader.textContent = `${days[i]}, ${currentDay.getDate()}`;
            dayCol.appendChild(dayHeader);
            
            // Add time slots for each day
            for (let hour = 0; hour < 24; hour++) {
                const slot = document.createElement('div');
                slot.className = 'week-slot';
                slot.dataset.date = currentDay.toISOString().split('T')[0];
                slot.dataset.hour = hour;
                dayCol.appendChild(slot);
            }
            
            daysColumn.appendChild(dayCol);
        }
        
        // Load assignments for this week
        loadWeekAssignments(startOfWeek);
    }
}

function renderYearView() {
    const yearGrid = document.getElementById('year-grid');
    if (!yearGrid) return;
    
    yearGrid.innerHTML = '';
    
    const year = currentMonth.getFullYear();
    const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                   'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
    
    months.forEach((monthName, index) => {
        const monthCard = document.createElement('div');
        monthCard.className = 'month-card';
        
        const monthHeader = document.createElement('h3');
        monthHeader.textContent = monthName;
        monthCard.appendChild(monthHeader);
        
        const miniCalendar = document.createElement('div');
        miniCalendar.className = 'mini-calendar';
        
        // Generate mini calendar for the month
        const firstDay = new Date(year, index, 1);
        const lastDay = new Date(year, index + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDayOfWeek = firstDay.getDay();
        
        // Add day headers
        const dayHeaders = ['M', 'S', 'S', 'R', 'K', 'J', 'S'];
        dayHeaders.forEach(day => {
            const dayHeader = document.createElement('div');
            dayHeader.className = 'mini-day-header';
            dayHeader.text